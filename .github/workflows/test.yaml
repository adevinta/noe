name: run tests

on:
  pull_request:
    branches: [ "*" ]
  push:
    branches:
    - "gh-readonly-queue/**/*"

jobs:
  testGo:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Setup Golang caches
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-golang-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-golang-

    - name: Setup Golang
      uses: actions/setup-go@v3
      with:
        go-version: '1.24.5'

    - name: Check for go.mod/go.sum changes
      uses: dorny/paths-filter@v2
      id: check-changes
      with:
        filters: |
          dependencies:
            - 'go.mod'
            - 'go.sum'

    - name: run go tests
      run: |
        go test -v ./...
      env:
        RUN_INTEGRATION_TESTS: true

    - name: run license tests
      if: steps.check-changes.outputs.dependencies == 'true'
      run: |
        go test -tags=license -v . -run "TestLicenses"

  testHelm:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        depth: 0

    - uses: azure/setup-helm@v4.2.0
      with:
        version: v3.12.0

    - name: Set up chart-testing
      uses: helm/chart-testing-action@v2.6.1

    - run: |
        git fetch origin "${{ github.base_ref }}"
        # Ensure the chart meets requirements 
        ct lint --remote origin --target-branch "${{ github.base_ref }}" --charts ./charts/noe 
        # Ensure the chart can be rendered with default values set and the generated yaml is coherent
        helm template ./charts/noe
        # Ensure the chart can be rendered with all values set and the generated yaml is coherent
        helm template ./charts/noe -f ./charts/noe/values-test-full.yaml